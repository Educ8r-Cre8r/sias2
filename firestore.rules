rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Ratings collection - allow public read/write
    match /ratings/{photoId} {
      // Anyone can read ratings
      allow read: if true;

      // Anyone can create or update ratings
      // This is safe for a public educational site
      allow create, update: if true;

      // Prevent deletion to preserve data integrity
      allow delete: if false;
    }

    // Views collection - allow public read/write
    match /views/{photoId} {
      // Anyone can read view counts
      allow read: if true;

      // Anyone can create or update view counts
      allow create, update: if true;

      // Prevent deletion to preserve data integrity
      allow delete: if false;
    }

    // User Ratings collection - track individual user ratings
    match /userRatings/{ratingId} {
      // Users can read their own ratings (needed for duplicate check)
      allow read: if true;

      // Authenticated users can create a rating (one per user per photo)
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;

      // Prevent updates and deletes to preserve rating integrity
      allow update, delete: if false;
    }

    // Favorites collection - require Google auth
    match /favorites/{favoriteId} {
      // Users can read/list their own favorites (non-anonymous only)
      allow read: if request.auth != null
        && request.auth.token.firebase.sign_in_provider != 'anonymous';

      // Authenticated (non-anonymous) users can create favorites
      allow create: if request.auth != null
        && request.auth.token.firebase.sign_in_provider != 'anonymous'
        && request.resource.data.userId == request.auth.uid;

      // Users can only delete their own favorites
      allow delete: if request.auth != null
        && request.auth.token.firebase.sign_in_provider != 'anonymous'
        && resource.data.userId == request.auth.uid;

      // No updates needed - favorites are add/remove only
      allow update: if false;
    }

    // Comments collection - require Google auth to write, approval to read
    match /comments/{commentId} {
      // Public can only read approved comments; admin can read all
      // Supports both new status field and legacy approved field
      allow read: if resource.data.status == 'approved'
        || resource.data.approved == true
        || (request.auth != null
            && request.auth.token.email == 'mr.alexdjones@gmail.com');

      // Authenticated (non-anonymous) users can create comments
      allow create: if request.auth != null
        && request.auth.token.firebase.sign_in_provider != 'anonymous'
        && request.resource.data.userId == request.auth.uid;

      // Admin can update (approve/reject) or delete any; users can delete own
      allow update: if request.auth != null
        && request.auth.token.email == 'mr.alexdjones@gmail.com';
      allow delete: if request.auth != null
        && (resource.data.userId == request.auth.uid
            || request.auth.token.email == 'mr.alexdjones@gmail.com');
    }

    // Test collection for connection testing
    match /_test/{document} {
      allow read: if true;
    }

    // Image processing queue - admin read/update/delete access for dashboard monitoring
    match /imageQueue/{docId} {
      allow read, update, delete: if request.auth != null
        && request.auth.token.email == 'mr.alexdjones@gmail.com';
    }

    // Aggregated stats — public read, Cloud Functions write only
    match /aggregations/{docId} {
      allow read: if true;
      allow write: if false;
    }

    // Trusted users collection - admin only
    match /trustedUsers/{userId} {
      allow read, write: if request.auth != null
        && request.auth.token.email == 'mr.alexdjones@gmail.com';
    }

    // View events — authenticated write, admin read only
    match /viewEvents/{eventId} {
      allow create: if true;
      allow read: if request.auth != null
        && request.auth.token.email == 'mr.alexdjones@gmail.com';
      allow update, delete: if false;
    }

    // Daily stats — admin read, Cloud Functions write only
    match /dailyStats/{dateId} {
      allow read: if request.auth != null
        && request.auth.token.email == 'mr.alexdjones@gmail.com';
      allow write: if false;
    }

    // Health checks — admin read, Cloud Functions write only
    match /healthChecks/{checkId} {
      allow read: if request.auth != null
        && request.auth.token.email == 'mr.alexdjones@gmail.com';
      allow write: if false;
    }

    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
