rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Ratings collection - allow public read/write
    match /ratings/{photoId} {
      // Anyone can read ratings
      allow read: if true;

      // Anyone can create or update ratings
      // This is safe for a public educational site
      allow create, update: if true;

      // Prevent deletion to preserve data integrity
      allow delete: if false;
    }

    // Views collection - allow public read/write
    match /views/{photoId} {
      // Anyone can read view counts
      allow read: if true;

      // Anyone can create or update view counts
      allow create, update: if true;

      // Prevent deletion to preserve data integrity
      allow delete: if false;
    }

    // Comments collection - require Google auth to write
    match /comments/{commentId} {
      // Anyone can read comments
      allow read: if true;

      // Authenticated (non-anonymous) users can create comments
      allow create: if request.auth != null
        && request.auth.token.firebase.sign_in_provider != 'anonymous'
        && request.resource.data.userId == request.auth.uid;

      // Users can only update/delete their own comments
      allow update, delete: if request.auth != null
        && resource.data.userId == request.auth.uid;
    }

    // Test collection for connection testing
    match /_test/{document} {
      allow read: if true;
    }

    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
